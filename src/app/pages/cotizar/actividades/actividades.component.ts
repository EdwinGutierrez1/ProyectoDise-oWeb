// actividades.component.ts - ACTUALIZADO
import { Component, OnInit, OnDestroy } from '@angular/core';
import { CommonModule } from '@angular/common';
import { Subscription } from 'rxjs';
import { CotizacionService, DatosCotizacion } from '../cotizacion.service';

interface Actividad {
  id: number;
  nombre: string;
  precio: string;
  precioNumerico: number; // Nuevo campo para c√°lculos
  imagen: string;
  descripcion: string;
  incluye: string[];
  duracion: string;
}

@Component({
  selector: 'app-actividades',
  standalone: true,
  imports: [CommonModule],
  templateUrl: './actividades.component.html',
  styleUrls: ['./actividades.component.css']
})
export class ActividadesComponent implements OnInit, OnDestroy {
  selectedActividades: number[] = [];
  showModal: boolean = false;
  selectedActivityId: number | null = null;
  selectedActivityData: Actividad | null = null;
  
  // Datos de la cotizaci√≥n actual
  cantidadPersonas: number = 0;
  datosCotizacion: DatosCotizacion | null = null;
  
  // Suscripci√≥n para cleanup
  private subscription: Subscription = new Subscription();

  // IDs de actividades que son "por persona"
  private actividadesPorPersona: number[] = [3, 4, 5, 6]; // Kayak, Bici, Senderismo, Escalada

  // Iconos para cada actividad
  private activityIcons: { [key: number]: string } = {
    1: 'üßò‚Äç‚ôÄÔ∏è', // Spa en pareja
    2: 'üçé',   // Picnic gourmet
    3: 'üõ∂',   // Kayak
    4: 'üöµ‚Äç‚ôÇÔ∏è', // Bici de monta√±a
    5: 'ü•æ',   // Senderismo
    6: '‚õ∞Ô∏è '    // Escalada en roca
  };

  // Datos de las actividades (actualizados con precios num√©ricos)
  private actividades: Actividad[] = [
    {
      id: 1,
      nombre: 'Spa en pareja',
      precio: '$150.000',
      precioNumerico: 150000,
      imagen: '/fotospa2.jpg',
      descripcion: 'Disfruta de una experiencia relajante y rom√°ntica en nuestro spa especializado para parejas. Un momento perfecto para conectar y relajarse juntos.',
      incluye: [
        '‚úîÔ∏è Masaje relajante para ambos',
        '‚úîÔ∏è Acceso a sauna y jacuzzi privado',
        '‚úîÔ∏è Aromaterapia personalizada',
        '‚úîÔ∏è Dos copas de champa√±a',
        '‚úîÔ∏è Toallas y batas de spa'
      ],
      duracion: '2 horas'
    },  
    {
      id: 2,
      nombre: 'Picnic gourmet en la naturaleza',
      precio: '$100.000',
      precioNumerico: 100000,
      imagen: '/fotopicnic2.jpeg',
      descripcion: 'Una experiencia culinaria √∫nica en medio de la naturaleza, con productos locales y org√°nicos preparados por nuestro chef especializado.',
      incluye: [
        '‚úîÔ∏è Cesta de picnic con mantel y utensilios',
        '‚úîÔ∏è Selecci√≥n de quesos artesanales locales',
        '‚úîÔ∏è Frutas frescas de temporada',
        '‚úîÔ∏è S√°ndwiches gourmet variados',
        '‚úîÔ∏è Bebidas naturales y vino',
        '‚úîÔ∏è Postre especial de la casa'
      ],
      duracion: '3 horas'
    },
    {
      id: 3,
      nombre: 'Kayak en r√≠o',
      precio: '$50.000',
      precioNumerico: 50000,
      imagen: '/fotokayak2.jpg',
      descripcion: 'Aventura acu√°tica perfecta para explorar los hermosos paisajes naturales desde una perspectiva √∫nica. Ideal para principiantes y expertos.',
      incluye: [
        '‚úîÔ∏è Kayak individual o doble',
        '‚úîÔ∏è Chaleco salvavidas y casco',
        '‚úîÔ∏è Remo y kit de seguridad',
        '‚úîÔ∏è Gu√≠a experto certificado',
        '‚úîÔ∏è Instrucci√≥n b√°sica de kayak',
        '‚úîÔ∏è Botella de agua'
      ],
      duracion: '2 horas'
    },
    {
      id: 4,
      nombre: 'Ruta en bici de monta√±a',
      precio: '$45.000',
      precioNumerico: 45000,
      imagen: '/fotobici2.jpg',
      descripcion: 'Recorre senderos naturales y disfruta de paisajes espectaculares en esta emocionante aventura sobre dos ruedas por terrenos monta√±osos.',
      incluye: [
        '‚úîÔ∏è Bicicleta de monta√±a de alta calidad',
        '‚úîÔ∏è Casco de seguridad',
        '‚úîÔ∏è Kit de reparaci√≥n b√°sico',
        '‚úîÔ∏è Gu√≠a especializado',
        '‚úîÔ∏è Mapa de rutas',
        '‚úîÔ∏è Hidrataci√≥n durante el recorrido'
      ],
      duracion: '3 horas'
    },
    {
      id: 5,
      nombre: 'Senderismo a cascada natural',
      precio: '$60.000',
      precioNumerico: 60000,
      imagen: '/fotocascada2.jpg',
      descripcion: 'Descubre una cascada secreta a trav√©s de senderos naturales. Una caminata moderada que te llevar√° a uno de los lugares m√°s hermosos de la regi√≥n.',
      incluye: [
        '‚úîÔ∏è Gu√≠a naturalista experto',
        '‚úîÔ∏è Bastones de senderismo',
        '‚úîÔ∏è Kit de primeros auxilios',
        '‚úîÔ∏è Snack energ√©tico',
        '‚úîÔ∏è Botella de agua reutilizable',
        '‚úîÔ∏è Informaci√≥n sobre flora y fauna local'
      ],
      duracion: '4 horas'
    },
    {
      id: 6,
      nombre: 'Escalada en roca',
      precio: '$70.000',
      precioNumerico: 70000,
      imagen: '/fotoescalada2.jpg',
      descripcion: 'Desaf√≠a tus l√≠mites con esta emocionante actividad de escalada en formaciones rocosas naturales, con total seguridad y supervisi√≥n profesional.',
      incluye: [
        '‚úîÔ∏è Equipo completo de escalada',
        '‚úîÔ∏è Arn√©s y casco de seguridad',
        '‚úîÔ∏è Cuerdas y sistema de aseguramiento',
        '‚úîÔ∏è Instructor certificado',
        '‚úîÔ∏è Clase b√°sica de t√©cnicas',
        '‚úîÔ∏è Seguro de actividad'
      ],
      duracion: '3 horas'
    }
  ];

  constructor(private cotizacionService: CotizacionService) {}

  ngOnInit(): void {
    // Suscribirse a cambios en la cotizaci√≥n
    this.subscription.add(
      this.cotizacionService.cotizacion$.subscribe(cotizacion => {
        this.datosCotizacion = cotizacion;
        this.cantidadPersonas = cotizacion.cantidadPersonas;
        
        // Actualizar selectedActividades basado en las actividades del servicio
        this.selectedActividades = cotizacion.actividades.map(a => a.id);
        
        console.log('Datos de cotizaci√≥n actualizados:', cotizacion);
        console.log('Cantidad de personas:', this.cantidadPersonas);
      })
    );

    // Listener para cerrar modal con Escape
    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && this.showModal) {
        this.closeModal();
      }
    });
  }

  ngOnDestroy(): void {
    this.subscription.unsubscribe();
  }

  /**
   * Verifica si una actividad es "por persona"
   * @param actividadId - ID de la actividad
   * @returns true si la actividad es por persona
   */
  isPorPersona(actividadId: number): boolean {
    return this.actividadesPorPersona.includes(actividadId);
  }

  /**
   * Calcula el precio total de una actividad seg√∫n si es por persona o no
   * @param actividadId - ID de la actividad
   * @returns Precio total calculado
   */
  calcularPrecioTotal(actividadId: number): number {
    const actividad = this.actividades.find(a => a.id === actividadId);
    if (!actividad) return 0;

    if (this.isPorPersona(actividadId)) {
      return actividad.precioNumerico * this.cantidadPersonas;
    }
    
    return actividad.precioNumerico;
  }

  /**
   * Obtiene el precio formateado para mostrar
   * @param actividadId - ID de la actividad
   * @returns String con el precio formateado
   */
  getPrecioMostrar(actividadId: number): string {
    const actividad = this.actividades.find(a => a.id === actividadId);
    if (!actividad) return '$0';

    if (this.isPorPersona(actividadId) && this.cantidadPersonas > 0) {
      const precioTotal = this.calcularPrecioTotal(actividadId);
      return `$${precioTotal.toLocaleString()} (${actividad.precio} x${this.cantidadPersonas})`;
    }
    
    return actividad.precio;
  }

  /**
   * Abre el modal con la informaci√≥n de la actividad seleccionada
   * @param actividadId - ID de la actividad
   */
  openModal(actividadId: number): void {
    this.selectedActivityId = actividadId;
    this.selectedActivityData = this.actividades.find(a => a.id === actividadId) || null;
    this.showModal = true;
    
    // Prevenir scroll del body cuando el modal est√° abierto
    document.body.style.overflow = 'hidden';
  }

  /**
   * Cierra el modal
   */
  closeModal(): void {
    this.showModal = false;
    this.selectedActivityId = null;
    this.selectedActivityData = null;
    
    // Restaurar scroll del body
    document.body.style.overflow = 'auto';
  }

  /**
   * Alterna la selecci√≥n de una actividad (agregar o quitar)
   */
  elegirActividad(): void {
    if (this.selectedActivityId) {
      const actividad = this.actividades.find(a => a.id === this.selectedActivityId);
      if (!actividad) return;

      if (this.isActividadSelected(this.selectedActivityId)) {
        // Quitar actividad del servicio
        this.cotizacionService.quitarActividad(this.selectedActivityId);
      } else {
        // Agregar actividad al servicio
        this.cotizacionService.agregarActividad({
          id: actividad.id,
          nombre: actividad.nombre,
          precioUnitario: actividad.precioNumerico,
          porPersona: this.isPorPersona(actividad.id)
        });
      }
      
      this.closeModal();
    }
  }

  /**
   * Verifica si una actividad est√° seleccionada
   * @param actividadId - ID de la actividad
   * @returns true si la actividad est√° seleccionada
   */
  isActividadSelected(actividadId: number): boolean {
    return this.cotizacionService.isActividadSeleccionada(actividadId);
  }

  /**
   * Verifica si el t√≠tulo es largo para mobile
   * @param actividadId - ID de la actividad
   * @returns true si tiene t√≠tulo largo
   */
  hasLongTitleForMobile(actividadId: number): boolean {
    const actividadesConTituloLargo = [2, 5]; // Picnic gourmet y Senderismo
    return actividadesConTituloLargo.includes(actividadId);
  }

  /**
   * Obtiene la lista de actividades seleccionadas con su informaci√≥n completa
   * @returns Array de actividades seleccionadas
   */
  getActividadesSeleccionadas(): Actividad[] {
    const actividadesDelServicio = this.cotizacionService.obtenerActividadesSeleccionadas();
    return this.actividades.filter(actividad => 
      actividadesDelServicio.some(a => a.id === actividad.id)
    );
  }

  /**
   * Obtiene el icono correspondiente a una actividad
   * @param activityId - ID de la actividad
   * @returns Emoji del icono o string vac√≠o si no existe
   */
  getActivityIcon(activityId: number): string {
    return this.activityIcons[activityId] || '';
  }

  /**
   * Obtiene el total de actividades seleccionadas
   * @returns N√∫mero de actividades seleccionadas
   */
  getTotalActividadesSeleccionadas(): number {
    return this.selectedActividades.length;
  }

  /**
   * Limpia todas las selecciones
   */
  limpiarSelecciones(): void {
    // Remover todas las actividades del servicio
    this.selectedActividades.forEach(actividadId => {
      this.cotizacionService.quitarActividad(actividadId);
    });
    
    console.log('Selecciones limpiadas');
  }

  /**
   * Obtiene informaci√≥n resumida de la selecci√≥n actual
   * @returns Objeto con informaci√≥n de las actividades seleccionadas
   */
  getResumenSeleccion(): {
    cantidad: number;
    actividades: string[];
    isValid: boolean;
    subtotal: number;
  } {
    const actividadesSeleccionadas = this.getActividadesSeleccionadas();
    const subtotal = this.datosCotizacion?.subtotalActividades || 0;
    
    return {
      cantidad: actividadesSeleccionadas.length,
      actividades: actividadesSeleccionadas.map(a => a.nombre),
      isValid: actividadesSeleccionadas.length > 0,
      subtotal: subtotal
    };
  }

  /**
   * Verifica si hay al menos una actividad seleccionada
   * @returns true si hay selecciones v√°lidas
   */
  hasValidSelection(): boolean {
    return this.selectedActividades.length > 0;
  }

  /**
   * Obtiene una actividad por su ID
   * @param id - ID de la actividad
   * @returns Actividad encontrada o null
   */
  getActividadById(id: number): Actividad | null {
    return this.actividades.find(actividad => actividad.id === id) || null;
  }

  /**
   * Maneja el cierre del modal con la tecla Escape
   * @param event - Evento del teclado
   */
  onKeyDown(event: KeyboardEvent): void {
    if (event.key === 'Escape' && this.showModal) {
      this.closeModal();
    }
  }

  /**
   * Verifica si se puede mostrar informaci√≥n de actividades (hay personas seleccionadas)
   * @returns true si hay personas seleccionadas en caba√±as
   */
  canShowActividades(): boolean {
    return this.cantidadPersonas > 0;
  }

  /**
   * Obtiene mensaje de advertencia si no hay personas seleccionadas
   * @returns Mensaje para mostrar al usuario
   */
  getMensajeAdvertencia(): string {
    if (this.cantidadPersonas === 0) {
      return 'Primero selecciona una caba√±a y la cantidad de personas para ver los precios de las actividades.';
    }
    return '';
  }

  /**
   * Obtiene el subtotal de actividades formateado
   * @returns String con el subtotal formateado
   */
  getSubtotalFormateado(): string {
    const subtotal = this.datosCotizacion?.subtotalActividades || 0;
    return `${subtotal.toLocaleString()}`;
  }

  /**
   * Verifica si hay una caba√±a seleccionada
   * @returns true si hay caba√±a seleccionada
   */
  tieneCabanaSeleccionada(): boolean {
    return this.datosCotizacion?.cabana !== null;
  }

    /**
   * Verifica si la caba√±a seleccionada es para parejas (ID 1)
   * @returns true si es caba√±a para parejas
   */
  esCabanaPareja(): boolean {
    return this.datosCotizacion?.cabana?.id === 1;
  }


  /**
   * Verifica si una actividad de pareja est√° deshabilitada por no tener caba√±a de pareja
   * @param actividadId - ID de la actividad
   * @returns true si est√° deshabilitada
   */
  isActividadParejaDeshabilitada(actividadId: number): boolean {
    return this.tieneCabanaSeleccionada() && !this.esCabanaPareja() && [1, 2].includes(actividadId);
  }

  
    /**
   * Verifica si se puede seleccionar una actividad
   * @param actividadId - ID de la actividad
   * @returns true si se puede seleccionar
   */

    canSelectActivity(actividadId: number): boolean {
      // No se puede seleccionar si no hay caba√±a
      if (!this.tieneCabanaSeleccionada()) {
        return false;
      }
      
      // Si NO es caba√±a para parejas y es actividad de pareja (1 o 2), no se puede seleccionar
      if (!this.esCabanaPareja() && [1, 2].includes(actividadId)) {
        return false;
      }
      
      return true;
    }


  /**
   * Obtiene informaci√≥n de actividades por persona vs fijas
   * @returns Objeto con conteos de actividades
   */
  getEstadisticasActividades(): {
    porPersona: number;
    fijas: number;
    total: number;
  } {
    const seleccionadas = this.getActividadesSeleccionadas();
    const porPersona = seleccionadas.filter(a => this.isPorPersona(a.id)).length;
    const fijas = seleccionadas.length - porPersona;

    return {
      porPersona,
      fijas,
      total: seleccionadas.length
    };
  }
}